<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phishing Email Analyzer (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <style>
      /* ------------------------------------------------------------------ */
      /* CSS Styles (Ø§Ù„ØªØµÙ…ÙŠÙ…)                                */
      /* ------------------------------------------------------------------ */

      :root {
        --primary: #007bff;
        --border-color: #ccc;
        --error-red: #dc3545;
        --success-green: #28a745;
        --suspicious-yellow: #ffc107;
        --malicious-red: #dc3545;
        --safe-green: #28a745;
        --neutral-gray: #6c757d;
        --bg-light: #f4f7f6;
        --panel-bg: white;
        --finding-header-color: #0056b3; /* Ù„ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø±Ø£Ø³ */
        --finding-attachment-color: #9c27b0; /* Ù„ÙˆÙ† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: var(--bg-light);
        padding: 20px;
        direction: rtl;
        text-align: right;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background-color: var(--panel-bg);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      /* 1. Upload Section */
      .upload-container {
        border: 3px dashed var(--border-color);
        border-radius: 10px;
        padding: 40px 20px;
        text-align: center;
        transition: border-color 0.3s, background-color 0.3s;
        background-color: #fff;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .upload-container.drag-over {
        border-color: var(--primary);
        background-color: #e6f7ff;
      }

      .upload-icon {
        font-size: 3em;
        color: var(--primary);
        margin-bottom: 10px;
      }

      .browse-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .file-name-display {
        margin-top: 15px;
        font-style: italic;
        color: #555;
      }

      .error-message {
        color: var(--malicious-red);
        margin-top: 10px;
        font-weight: bold;
      }

      /* Scan Button & Loading */
      .action-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
      }

      .scan-btn {
        padding: 12px 25px;
        font-size: 1.1em;
        background-color: var(--safe-green);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .scan-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .loading-state {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--primary);
        margin-right: 20px;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none !important;
      }

      /* 3. Summary Visualization */
      .summary-visualization {
        margin-bottom: 30px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .score-banner {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 25px;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
      }

      /* Color-coding for banners */
      .status-safe {
        background-color: var(--safe-green);
      }
      .status-suspicious {
        background-color: var(--suspicious-yellow);
      }
      .status-malicious {
        background-color: var(--malicious-red);
      }

      .score-box {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9em;
      }

      .risk-banner {
        padding: 10px 25px;
        background-color: var(--malicious-red);
        color: white;
        font-weight: bold;
        font-size: 1em;
        text-align: center;
      }

      /* 4. Detailed Findings Panels */
      .findings-panel h3 {
        color: #333;
        margin-top: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 15px;
        font-size: 1.1em;
      }

      .findings-list {
        margin-top: 10px;
        display: grid;
        gap: 10px;
      }

      .finding-item {
        background-color: var(--bg-light);
        padding: 15px;
        border-radius: 6px;
        border-right: 5px solid var(--neutral-gray); /* Default */
        line-height: 1.6;
      }

      .finding-item.header {
        border-right-color: var(--finding-header-color);
      }
      .finding-item.link {
        border-right-color: var(--error-red);
      }
      .finding-item.attachment {
        border-right-color: var(--finding-attachment-color);
      }
      .finding-item.typo {
        border-right-color: var(--suspicious-yellow);
      }

      .finding-item strong {
        display: block;
        margin-bottom: 5px;
        color: #333;
      }

      .recommendation {
        margin-top: 10px;
        padding: 8px;
        background-color: #ffe6e6;
        border-radius: 4px;
        color: #8b0000;
        font-size: 0.9em;
        font-weight: bold;
      }

      /* 5. Raw JSON Viewer */
      .json-viewer {
        margin-top: 30px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .json-header {
        background-color: #f0f0f0;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-weight: bold;
      }

      .json-actions button {
        background: var(--neutral-gray);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }

      .json-content {
        padding: 15px;
        background-color: #272822;
        color: #f8f8f2;
        overflow-x: auto;
        max-height: 400px;
        display: none;
      }

      .json-content.expanded {
        display: block;
      }

      pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* 6. History of Recent Scans */
      .recent-scans-panel {
        margin-top: 30px;
      }

      .scan-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 15px;
        border-bottom: 1px dashed #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .scan-item:hover {
        background-color: #f0f0f0;
      }

      .risk-safe {
        color: var(--safe-green);
      }
      .risk-malicious {
        color: var(--malicious-red);
      }
      .risk-suspicious {
        color: var(--suspicious-yellow);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„ÙØ­Øµ</h2>
      <div class="upload-container" id="drop-area">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <p>
          Ù‚Ù… Ø¨Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù…Ù„Ù
          <span style="font-weight: bold; color: var(--primary)">.eml</span> Ù‡Ù†Ø§
        </p>
        <p class="separator">Ø£Ùˆ</p>
        <input type="file" id="eml-file-input" accept=".eml" hidden />
        <button
          class="browse-btn"
          onclick="document.getElementById('eml-file-input').click()"
        >
          ØªØµÙØ­ Ø§Ù„Ù…Ù„ÙØ§Øª
        </button>
        <p class="file-name-display" id="file-display">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</p>
        <p class="error-message" id="upload-error"></p>
      </div>

      <div class="action-bar">
        <button class="scan-btn" id="scan-button" disabled>Ø±ÙØ¹ Ùˆ ÙØ­Øµ</button>
        <div class="loading-state hidden" id="loading-indicator">
          <div class="spinner"></div>
          <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        </div>
      </div>

      <div id="results-area" class="hidden">
        <h2>Ù…Ù„Ø®Øµ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
        <div class="summary-visualization" id="summary-viz"></div>

        <div class="findings-panel">
          <h3>
            <i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© ÙˆØ§Ù„ÙƒØ´Ù
            (Findings)
          </h3>

          <div id="findings-container"></div>

          <div id="no-findings" class="finding-item hidden">
            <p style="color: var(--safe-green); font-weight: bold">
              âœ… Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·ÙŠØ±Ø© Ø£Ùˆ Ù…Ø´Ø¨ÙˆÙ‡Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.
            </p>
          </div>
        </div>

        <div class="json-viewer">
          <div class="json-header" id="json-header-toggle">
            <i class="fas fa-angle-left" id="toggle-icon"></i> Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± JSON
            Ø§Ù„Ø®Ø§Ù…
            <div class="json-actions">
              <button id="search-json-btn" disabled>Ø¨Ø­Ø«</button>
              <button id="copy-json-btn">Ù†Ø³Ø®</button>
              <button id="download-json-btn">ØªÙ†Ø²ÙŠÙ„</button>
            </div>
          </div>
          <div class="json-content" id="raw-json-content">
            <pre id="json-pre-area"></pre>
          </div>
        </div>
      </div>

      <div class="recent-scans-panel">
        <h2>
          <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ø®ÙŠØ±Ø© (Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ)
        </h2>
        <div id="recent-scans-list">
          <p style="color: #999">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>
        </div>
      </div>
    </div>

    <script>
      // ------------------------------------------------------------------
      //                         JavaScript Logic
      // ------------------------------------------------------------------

      // DOM Elements
      const dropArea = document.getElementById("drop-area");
      const fileInput = document.getElementById("eml-file-input");
      const fileNameDisplay = document.getElementById("file-display");
      const uploadError = document.getElementById("upload-error");
      const scanButton = document.getElementById("scan-button");
      const loadingIndicator = document.getElementById("loading-indicator");
      const resultsArea = document.getElementById("results-area");
      const summaryViz = document.getElementById("summary-viz");
      const findingsContainer = document.getElementById("findings-container");
      const noFindings = document.getElementById("no-findings");
      const jsonHeaderToggle = document.getElementById("json-header-toggle");
      const jsonContent = document.getElementById("raw-json-content");
      const jsonPreArea = document.getElementById("json-pre-area");
      const toggleIcon = document.getElementById("toggle-icon");
      const recentScansList = document.getElementById("recent-scans-list");

      let selectedFile = null;
      let mockCounter = 0; // Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©

      // --- 1. Upload & Validation Logic ---
      function handleFile(file) {
        if (!file) {
          fileNameDisplay.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù";
          uploadError.textContent = "";
          scanButton.disabled = true;
          return null;
        }

        if (file.name.endsWith(".eml")) {
          fileNameDisplay.textContent = `Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±: ${file.name}`;
          uploadError.textContent = "";
          scanButton.disabled = false;
          return file;
        } else {
          fileNameDisplay.textContent = "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±: " + file.name;
          uploadError.textContent = "Ù…Ù„ÙØ§Øª .eml ÙÙ‚Ø· Ù…Ø¯Ø¹ÙˆÙ…Ø©. (Ù„Ù… ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„ÙØ­Øµ)";
          scanButton.disabled = true;
          return null;
        }
      }

      // Handle file input change & Drag and Drop (Same as before)
      fileInput.addEventListener("change", function (e) {
        selectedFile = handleFile(e.target.files[0]);
      });

      // Drag and Drop handlers
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(
          eventName,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        );
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        dropArea.addEventListener(
          eventName,
          () => dropArea.classList.add("drag-over"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(
          eventName,
          () => dropArea.classList.remove("drag-over"),
          false
        );
      });

      dropArea.addEventListener(
        "drop",
        function (e) {
          const dt = e.dataTransfer;
          const file = dt.files[0];
          fileInput.files = dt.files;
          selectedFile = handleFile(file);
        },
        false
      );

      // --- 2. Calling the Scan API ---
      scanButton.addEventListener("click", async function () {
        if (!selectedFile) return;

        // 1. Show Loading State
        scanButton.classList.add("hidden");
        loadingIndicator.classList.remove("hidden");
        resultsArea.classList.add("hidden");

        // Prepare the file upload to backend `/scan`
        const formData = new FormData();
        formData.append("eml", selectedFile);

        try {
          const resp = await fetch("/scan", { method: "POST", body: formData });
          if (!resp.ok) {
            // fallback to mock if server fails
            throw new Error("Server error");
          }
          const result = await resp.json();
          renderResults(result);
        } catch (err) {
          // If backend not available or error, fall back to a simple mock to avoid blocking UX
          console.warn("Backend scan failed, using frontend mock.", err);
          mockCounter = (mockCounter % 3) + 1;
          let mockResponse;
          if (mockCounter === 1) {
            mockResponse = {
              status: "malicious",
              score: 98.1,
              verdict: "MALICIOUS",
              sender: "Accounts@paypals.com",
              subject: "Your Account Has Been Limited",
              attachments: 1,
              links: 3,
              findings: [
                {
                  type: "attachment",
                  reason: "double_extension",
                  details: { filename: "invoice.pdf.exe" },
                },
                {
                  type: "link",
                  reason: "domain_not_allowed",
                  details: { link: "http://malicious.link" },
                },
              ],
              raw_report: {
                metadata: { date: new Date().toISOString() },
                full_analysis: { type: "Malicious" },
              },
            };
          } else if (mockCounter === 2) {
            mockResponse = {
              status: "suspicious",
              score: 65.0,
              verdict: "SUSPICIOUS",
              sender: "support@amazon-updates.co",
              subject: "Action Required: Shipping Address",
              attachments: 0,
              links: 1,
              findings: [
                {
                  type: "typo",
                  reason: "unicode_homograph",
                  details: { domain: "microsÃ¸ft.com" },
                },
              ],
              raw_report: {
                metadata: { date: new Date().toISOString() },
                full_analysis: { type: "Suspicious" },
              },
            };
          } else {
            mockResponse = {
              status: "safe",
              score: 1.5,
              verdict: "SAFE",
              sender: "info@mybank.com",
              subject: "Monthly Statement",
              attachments: 0,
              links: 0,
              findings: [],
              raw_report: {
                metadata: { date: new Date().toISOString() },
                full_analysis: { type: "Safe" },
              },
            };
          }
          renderResults(mockResponse);
        } finally {
          // restore UI state
          scanButton.classList.remove("hidden");
          loadingIndicator.classList.add("hidden");
        }
      });

      // ----------------------------------------------------
      // C. Rendering Functions
      // ----------------------------------------------------

      function renderResults(response) {
        renderSummary(
          response.status,
          response.score,
          response.subject,
          response.sender
        );
        renderFindings(response.findings);
        renderRawJson(response.raw_report);
        updateRecentScans(
          response.subject || selectedFile.name,
          response.status,
          response.score
        );
        resultsArea.classList.remove("hidden");
      }

      // --- 3. Risk Summary Visualization (Updated to show Sender/Subject) ---
      function renderSummary(status, score, subject, sender) {
        let className, statusText;

        if (status === "malicious") {
          className = "status-malicious";
          statusText = "Ø®Ø·Ø± Ù…Ø±ØªÙØ¹";
        } else if (status === "suspicious") {
          className = "status-suspicious";
          statusText = "Ù…Ø´Ø¨ÙˆÙ‡";
        } else {
          className = "status-safe";
          statusText = "Ø¢Ù…Ù†";
        }

        const html = `
                <div class="score-banner ${className}">
                    <span>${statusText}</span>
                    <span class="score-box">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${score.toFixed(1)}%</span>
                </div>
                ${
                  status === "malicious"
                    ? `<div class="risk-banner">ğŸš¨ ${statusText} - ÙŠÙˆØµÙ‰ Ø¨Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¹Ø¯Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹Ù‡Ø§.</div>`
                    : ""
                }
                <div style="padding: 15px; background-color: white; border-top: 1px solid #ddd;">
                    <strong>Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${sender || "ØºÙŠØ± Ù…ØªÙˆÙØ±"} | 
                    <strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> ${subject || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}
                </div>
            `;
        summaryViz.innerHTML = html;
      }

      // --- 4. Detailed Findings Panels (Dynamic Rendering based on detection.py logic) ---
      function renderFindings(findings) {
        findingsContainer.innerHTML = "";

        if (!findings || findings.length === 0) {
          noFindings.classList.remove("hidden");
          return;
        }

        noFindings.classList.add("hidden");

        findings.forEach((finding) => {
          const item = document.createElement("div");
          let title = "Ù†ØªÙŠØ¬Ø© ÙƒØ´Ù Ø¹Ø§Ù…Ø©",
            description = "";
          let typeClass = finding.type; // ÙŠØ³ØªØ®Ø¯Ù… Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©

          // **ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ detection.py Ù‡Ù†Ø§:**

          if (finding.reason === "DKIM_FAIL" || finding.reason === "SPF_FAIL") {
            title = `ÙØ´Ù„ Ù…ØµØ§Ø¯Ù‚Ø© ${finding.details.method} (${finding.details.reason})`;
            description = `**Ø§Ù„ØªØ­Ù‚Ù‚:** ${finding.details.method} <br> **Ø§Ù„ÙˆØµÙ:** ÙØ´Ù„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©/ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ø·Ø§Ù‚ØŒ Ù…Ù…Ø§ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ø£Ù† Ø§Ù„Ù…Ø±Ø³Ù„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù†ØªØ­Ù„Ø§Ù‹.`;
            typeClass = "header";
          } else if (finding.reason === "display_name_spoofing") {
            title = `Ø§Ù†ØªØ­Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©`;
            description = `**Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±:** "${finding.details.display_name}" <br> **Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ:** ${finding.details.domain} <br> **Ø§Ù„ÙˆØµÙ:** ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø¹Ù„Ø§Ù…Ø© ØªØ¬Ø§Ø±ÙŠØ© Ù…Ø¹Ø±ÙˆÙØ© ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶ØŒ Ù„ÙƒÙ† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ø§ ÙŠÙ…Øª Ù„Ù‡Ø§ Ø¨ØµÙ„Ø©.`;
            typeClass = "typo";
          } else if (finding.reason === "double_extension") {
            title = `Ù…Ù„Ø­Ù‚ Ø®Ø·Ø± Ø¨Ø§Ù…ØªØ¯Ø§Ø¯ Ù…Ø²Ø¯ÙˆØ¬`;
            description = `**Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:** ${finding.details.filename} <br> **Ø§Ù„ÙˆØµÙ:** ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù…ØªØ¯Ø§Ø¯ÙŠÙ†ØŒ Ù…Ù…Ø§ Ù‚Ø¯ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø®ÙØ§Ø¡ Ù…Ù„Ù ØªÙ†ÙÙŠØ°ÙŠ Ø®Ø¨ÙŠØ« (.exe, .js, Ø¥Ù„Ø®). <span style="color:var(--malicious-red);">ÙŠØ¬Ø¨ Ø¹Ø¯Ù… ÙØªØ­Ù‡ Ù…Ø·Ù„Ù‚Ø§Ù‹.</span>`;
            typeClass = "attachment";
          } else if (finding.reason === "domain_not_allowed") {
            title = `Ø±Ø§Ø¨Ø· ØªØ´Ø¹Ø¨ÙŠ Ù…Ø´Ø¨ÙˆÙ‡`;
            description = `**Ù†Øµ Ø§Ù„Ø±Ø§Ø¨Ø·:** ${
              finding.details.text || "ØºÙŠØ± Ù…ØªÙˆÙØ±"
            } <br> **Ø§Ù„ÙˆØ¬Ù‡Ø©:** ${
              finding.details.link
            } <br> **Ø§Ù„ÙˆØµÙ:** Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ Ù†Ø·Ø§Ù‚ ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø±Ø³Ù„ Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©.`;
            typeClass = "link";
          } else if (finding.reason === "social_engineering_language") {
            title = `Ù„ØºØ© Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© (Ø¥Ù„Ø­Ø§Ø­/ØªÙ‡Ø¯ÙŠØ¯)`;
            description = `**Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ©:** "${finding.details.snippet.substring(
              0,
              50
            )}..." <br> **Ø§Ù„ÙˆØµÙ:** ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù„ØºØ© ØªØ¯Ø¹Ùˆ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù„Ø­Ø§Ø­ Ø£Ùˆ Ø§Ù„ØªÙ‡Ø¯ÙŠØ¯ØŒ ÙˆÙ‡ÙŠ ØªÙ‚Ù†ÙŠØ© ØªØµÙŠØ¯ Ø´Ø§Ø¦Ø¹Ø©.`;
            typeClass = "body";
          }

          item.className = `finding-item ${typeClass}`;
          item.innerHTML = `
                    <strong>${title}</strong>
                    <p>${description}</p>
                    <div class="recommendation">
                        **Ø§Ù„ØªÙˆØµÙŠØ©:** Ù‚Ù… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø¹Ù†Ø§ÙŠØ©ØŒ ÙˆÙ„Ø§ ØªÙ‚Ù… Ø¨ÙØªØ­ Ø£ÙŠ Ù…Ø±ÙÙ‚Ø§Øª Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø·.
                    </div>
                `;
          findingsContainer.appendChild(item);
        });
      }

      // --- 5. Raw JSON Viewer ---
      function renderRawJson(rawJson) {
        jsonPreArea.textContent = JSON.stringify(rawJson, null, 2);
      }

      // JSON Toggle functionality
      jsonHeaderToggle.addEventListener("click", () => {
        const isExpanded = jsonContent.classList.contains("expanded");
        if (isExpanded) {
          jsonContent.classList.remove("expanded");
          toggleIcon.classList.replace("fa-angle-down", "fa-angle-left");
        } else {
          jsonContent.classList.add("expanded");
          toggleIcon.classList.replace("fa-angle-left", "fa-angle-down");
        }
      });

      // JSON Action Buttons (Copy/Download)
      document.getElementById("copy-json-btn").addEventListener("click", () => {
        navigator.clipboard.writeText(jsonPreArea.textContent).then(() => {
          alert("ØªÙ… Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ± JSON.");
        });
      });

      document
        .getElementById("download-json-btn")
        .addEventListener("click", () => {
          const dataStr =
            "data:text/json;charset=utf-8," +
            encodeURIComponent(jsonPreArea.textContent);
          const downloadAnchorNode = document.createElement("a");
          downloadAnchorNode.setAttribute("href", dataStr);
          downloadAnchorNode.setAttribute("download", "scan_report.json");
          document.body.appendChild(downloadAnchorNode);
          downloadAnchorNode.click();
          downloadAnchorNode.remove();
        });

      // --- 6. History of Recent Scans (Local Storage) ---
      function getHistory() {
        const history = localStorage.getItem("scanHistory");
        return history ? JSON.parse(history) : [];
      }

      function saveHistory(history) {
        localStorage.setItem("scanHistory", JSON.stringify(history));
      }

      function updateRecentScans(name, status, score) {
        const history = getHistory();
        const date = new Date()
          .toISOString()
          .substring(0, 16)
          .replace("T", " ");
        const riskClass =
          status === "malicious"
            ? "risk-malicious"
            : status === "suspicious"
            ? "risk-suspicious"
            : "risk-safe";
        const riskText =
          status === "malicious"
            ? "**Ø®Ø·Ø± Ù…Ø±ØªÙØ¹**"
            : status === "suspicious"
            ? "Ù…Ø´Ø¨ÙˆÙ‡"
            : "Ù…Ù†Ø®ÙØ¶";

        const newItem = {
          date: date,
          name: name,
          riskClass: riskClass,
          riskText: riskText,
          score: score.toFixed(1),
        };

        history.unshift(newItem);
        if (history.length > 5) {
          history.pop();
        }
        saveHistory(history);
        renderHistoryPanel();
      }

      function renderHistoryPanel() {
        const history = getHistory();
        recentScansList.innerHTML = "";

        if (history.length === 0) {
          recentScansList.innerHTML =
            '<p style="color: #999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ÙØ­Øµ Ù…Ø­Ù„ÙŠ Ø­Ø§Ù„ÙŠÙ‹Ø§.</p>';
          return;
        }

        history.forEach((item) => {
          const div = document.createElement("div");
          div.className = "scan-item";
          div.innerHTML = `
                    <span class="scan-details">${item.date} - ${item.name}</span>
                    <span class="${item.riskClass}">Ø§Ù„Ø®Ø·Ø±: ${item.riskText} (${item.score}%)</span>
                `;
          recentScansList.appendChild(div);
        });
      }

      // Initial load: Render history from local storage
      document.addEventListener("DOMContentLoaded", () => {
        renderHistoryPanel();
      });
    </script>
  </body>
</html>